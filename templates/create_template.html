<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Template - Maximally Outreach Dashboard</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .toolbar-section {
            border: 1px solid var(--bs-border-color);
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
            background: var(--bs-gray-900);
        }
        .content-editor {
            min-height: 300px;
            font-family: monospace;
        }
        .preview-content {
            background: var(--bs-gray-800);
            padding: 1.5rem;
            border-radius: 0.375rem;
            border: 1px solid var(--bs-border-color);
            min-height: 300px;
        }
        .preview-content a {
            color: #61dafb;
            text-decoration: underline;
        }
        .preview-content a:hover {
            color: #21b1c4;
        }
        .preview-content img {
            max-width: 100%;
            height: auto;
        }
        .preview-content h1, .preview-content h2, .preview-content h3, 
        .preview-content h4, .preview-content h5, .preview-content h6 {
            color: var(--bs-light);
            margin-bottom: 0.75rem;
        }
        .preview-content p {
            margin-bottom: 1rem;
        }
        .preview-content ul, .preview-content ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }
        .placeholder-tag {
            background: var(--bs-info);
            color: var(--bs-white);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            cursor: pointer;
        }
        .toolbar-btn {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-envelope-heart"></i> Maximally Outreach Dashboard
            </a>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row">
            <!-- Template Editor -->
            <div class="col-lg-8">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-plus-circle text-success"></i> Create New Email Template
                        </h5>
                        <a href="/" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-arrow-left"></i> Back to Dashboard
                        </a>
                    </div>
                    <div class="card-body">
                        <form method="post" id="templateForm">
                            <input type="hidden" name="content_text" id="hidden_content_text" value="">
                            <input type="hidden" name="content_html" id="hidden_content_html" value="">
                            <!-- Template Name -->
                            <div class="mb-4">
                                <label for="name" class="form-label fw-semibold">
                                    <i class="bi bi-tag"></i> Template Name
                                </label>
                                <input type="text" class="form-control form-control-lg" id="name" name="name" 
                                       placeholder="e.g., Welcome Outreach, Partnership Inquiry" required>
                                <div class="form-text">Choose a descriptive name for easy identification</div>
                            </div>

                            <!-- Email Subject -->
                            <div class="mb-4">
                                <label for="subject" class="form-label fw-semibold">
                                    <i class="bi bi-envelope"></i> Email Subject
                                </label>
                                <input type="text" class="form-control form-control-lg" id="subject" name="subject" 
                                       placeholder="Partnership Opportunity with {{school_name}}" required 
                                       oninput="updatePreview()">
                                <div class="form-text">
                                    <i class="bi bi-lightbulb text-warning"></i>
                                    Available placeholders: 
                                    <span class="placeholder-tag" onclick="insertText('subject', '{{school_name}}')">{{school_name}}</span>
                                    <span class="placeholder-tag" onclick="insertText('subject', '{{contact_person}}')">{{contact_person}}</span>
                                    <span class="placeholder-tag" onclick="insertText('subject', '{{city}}')">{{city}}</span>
                                    <span class="placeholder-tag" onclick="insertText('subject', '{{email}}')">{{email}}</span>
                                </div>
                            </div>

                            <!-- Content Type Tabs -->
                            <div class="mb-3">
                                <ul class="nav nav-tabs" id="contentTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="plain-text-tab" data-bs-toggle="tab" 
                                                data-bs-target="#plain-text-pane" type="button" role="tab">
                                            <i class="bi bi-file-text"></i> Plain Text
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="html-tab" data-bs-toggle="tab" 
                                                data-bs-target="#html-pane" type="button" role="tab">
                                            <i class="bi bi-code-slash"></i> HTML
                                        </button>
                                    </li>
                                </ul>
                            </div>

                            <!-- Tab Content -->
                            <div class="tab-content" id="contentTabsContent">
                                <!-- Plain Text Tab -->
                                <div class="tab-pane fade show active" id="plain-text-pane" role="tabpanel">
                                    <div class="toolbar-section">
                                        <h6 class="mb-3"><i class="bi bi-tools"></i> Quick Tools</h6>
                                        <button type="button" class="btn btn-sm btn-outline-info toolbar-btn" 
                                                onclick="insertText('content-text', '{{school_name}}')">
                                            <i class="bi bi-building"></i> School Name
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-info toolbar-btn" 
                                                onclick="insertText('content-text', '{{contact_person}}')">
                                            <i class="bi bi-person"></i> Contact Person
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-info toolbar-btn" 
                                                onclick="insertText('content-text', '{{city}}')">
                                            <i class="bi bi-geo-alt"></i> City
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-info toolbar-btn" 
                                                onclick="insertText('content-text', '{{email}}')">
                                            <i class="bi bi-envelope-at"></i> Email
                                        </button>
                                    </div>

                                    <label for="content" class="form-label fw-semibold">
                                        <i class="bi bi-file-text"></i> Email Content (Plain Text)
                                    </label>
                                    <textarea class="form-control content-editor" id="content-text" name="content" 
                                              rows="15" oninput="updatePreview()" 
                                              placeholder="Dear {{contact_person}},

I hope this email finds you well. I'm reaching out from Maximally regarding an exciting partnership opportunity with {{school_name}}.

[Your message here]

Best regards,
Maximally Team"></textarea>
                                </div>

                                <!-- HTML Tab -->
                                <div class="tab-pane fade" id="html-pane" role="tabpanel">
                                    <div class="toolbar-section">
                                        <h6 class="mb-3"><i class="bi bi-palette"></i> HTML Tools</h6>
                                        <button type="button" class="btn btn-sm btn-outline-success toolbar-btn" 
                                                onclick="insertHTML('content-html', '<p><strong>Bold text here</strong></p>')">
                                            <i class="bi bi-type-bold"></i> Bold
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success toolbar-btn" 
                                                onclick="insertHTML('content-html', '<p><em>Italic text here</em></p>')">
                                            <i class="bi bi-type-italic"></i> Italic
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success toolbar-btn" 
                                                onclick="insertHTML('content-html', '<a href=\'https://example.com\'>Link text</a>')">
                                            <i class="bi bi-link-45deg"></i> Link
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success toolbar-btn" 
                                                onclick="insertHTML('content-html', '<img src=\'https://example.com/image.jpg\' alt=\'Description\' style=\'max-width: 100%; height: auto;\'>')">
                                            <i class="bi bi-image"></i> Image
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success toolbar-btn" 
                                                onclick="insertHTML('content-html', '<ul><li>List item 1</li><li>List item 2</li></ul>')">
                                            <i class="bi bi-list-ul"></i> List
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success toolbar-btn" 
                                                onclick="insertHTML('content-html', '<br><hr><br>')">
                                            <i class="bi bi-dash-lg"></i> Divider
                                        </button>
                                    </div>

                                    <label for="content-html" class="form-label fw-semibold">
                                        <i class="bi bi-code-slash"></i> Email Content (HTML)
                                    </label>
                                    <textarea class="form-control content-editor" id="content-html" name="content" 
                                              rows="15" oninput="updatePreview()" 
                                              placeholder="<h2>Hello {{contact_person}}!</h2>

<p>I hope this email finds you well. I'm reaching out from <strong>Maximally</strong> regarding an exciting partnership opportunity with <strong>{{school_name}}</strong>.</p>

<p>We believe our program could benefit students in {{city}} by:</p>
<ul>
    <li>Providing hands-on learning experiences</li>
    <li>Connecting students with industry professionals</li>
    <li>Offering career development resources</li>
</ul>

<p>Would you be interested in scheduling a brief call to discuss this further?</p>

<p><strong>Best regards,</strong><br>
The Maximally Team</p>

<hr>
<p><small>This email was sent to {{email}}</small></p>"></textarea>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-flex gap-2 mt-4">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="bi bi-plus-circle"></i> Create Template
                                </button>
                                <button type="button" class="btn btn-outline-info btn-lg" onclick="updatePreview()">
                                    <i class="bi bi-arrow-clockwise"></i> Update Preview
                                </button>
                                <a href="/" class="btn btn-outline-secondary btn-lg">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Live Preview -->
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-eye text-info"></i> Live Preview
                        </h5>
                        <small class="text-muted">See how your email will look to recipients</small>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Subject:</strong>
                            <div id="preview-subject" class="mt-1 p-2 bg-secondary rounded">
                                Partnership Opportunity with Sample High School
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Content Preview:</strong>
                            <div id="preview-content" class="preview-content">
                                <p><em>Start typing to see your email preview...</em></p>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <h6><i class="bi bi-info-circle"></i> Sample Data Used:</h6>
                            <small>
                                • School: Sample High School<br>
                                • Contact: John Smith<br>
                                • City: Test City<br>
                                • Email: contact@sample.edu
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Sample data for preview
        const sampleData = {
            'school_name': 'Sample High School',
            'contact_person': 'John Smith',
            'city': 'Test City',
            'email': 'contact@sample.edu'
        };

        // Replace placeholders with sample data
        function replacePlaceholders(text) {
            let result = text;
            for (const [key, value] of Object.entries(sampleData)) {
                result = result.replaceAll(`{{ '{{' }}${key}{{ '}}' }}`, value);
            }
            return result;
        }

        // Update preview
        function updatePreview() {
            const subject = document.getElementById('subject').value || 'Partnership Opportunity with {{school_name}}';
            
            // Update subject preview
            document.getElementById('preview-subject').innerHTML = replacePlaceholders(subject);
            
            // Update content preview
            const previewContent = document.getElementById('preview-content');
            const activeTab = document.querySelector('.tab-pane.active');
            
            if (activeTab && activeTab.id === 'html-pane') {
                // HTML preview
                const htmlContent = document.getElementById('content-html').value || '<h2>Hello {{contact_person}}!</h2>';
                previewContent.innerHTML = replacePlaceholders(htmlContent);
            } else {
                // Plain text preview
                const textContent = document.getElementById('content-text').value || 'Start typing to see your email preview...';
                previewContent.innerHTML = '<pre style="white-space: pre-wrap; font-family: inherit;">' + 
                                         replacePlaceholders(textContent) + '</pre>';
            }
        }

        // Insert text at cursor position
        function insertText(fieldId, text) {
            const field = document.getElementById(fieldId);
            const start = field.selectionStart;
            const end = field.selectionEnd;
            const currentValue = field.value;
            
            field.value = currentValue.substring(0, start) + text + currentValue.substring(end);
            field.focus();
            field.setSelectionRange(start + text.length, start + text.length);
            
            updatePreview();
        }

        // Insert HTML at cursor position
        function insertHTML(fieldId, html) {
            insertText(fieldId, html);
        }

        // Handle form submission to use correct content
        function handleFormSubmission() {
            const form = document.getElementById('templateForm');
            
            // Update hidden fields with current content
            const contentTextValue = document.getElementById('content-text').value;
            const contentHtmlValue = document.getElementById('content-html').value;
            
            document.getElementById('hidden_content_text').value = contentTextValue;
            document.getElementById('hidden_content_html').value = contentHtmlValue;
            
            // Remove any existing hidden content field
            const existingHidden = form.querySelector('input[name="content"]');
            if (existingHidden) {
                existingHidden.remove();
            }
            
            // Create hidden input with the correct content based on active tab
            const activeTab = document.querySelector('.tab-pane.active');
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'content';
            
            if (activeTab && activeTab.id === 'html-pane') {
                hiddenInput.value = contentHtmlValue;
            } else {
                hiddenInput.value = contentTextValue;
            }
            
            form.appendChild(hiddenInput);
            return true;
        }

        // Update preview on tab change
        document.addEventListener('DOMContentLoaded', function() {
            updatePreview();
            
            // Add form submission handler
            document.getElementById('templateForm').addEventListener('submit', handleFormSubmission);
            
            // Update preview when switching tabs
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function() {
                    setTimeout(updatePreview, 100);
                });
            });
        });
    </script>
</body>
</html>